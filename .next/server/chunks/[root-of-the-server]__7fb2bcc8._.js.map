{"version":3,"sources":["../../../lib/jwt.ts"],"sourcesContent":["import crypto from \"crypto\"\n\nfunction base64url(input: Buffer | string) {\n  const buf = Buffer.isBuffer(input) ? input : Buffer.from(input)\n  return buf\n    .toString(\"base64\")\n    .replace(/=/g, \"\")\n    .replace(/\\+/g, \"-\")\n    .replace(/\\//g, \"_\")\n}\n\nexport async function signJwt(payload: Record<string, unknown>) {\n  const hasRS256 = !!(process.env.JWT_PRIVATE_KEY && process.env.JWT_PUBLIC_KEY)\n  const header = { alg: hasRS256 ? \"RS256\" : \"HS256\", typ: \"JWT\" }\n  const iat = Math.floor(Date.now() / 1000)\n  const expEnv = (process.env.JWT_EXPIRES_IN || \"7d\").toLowerCase()\n  const expSeconds =\n    expEnv.endsWith(\"d\")\n      ? parseInt(expEnv) * 24 * 60 * 60\n      : expEnv.endsWith(\"h\")\n      ? parseInt(expEnv) * 60 * 60\n      : expEnv.endsWith(\"m\")\n      ? parseInt(expEnv) * 60\n      : parseInt(expEnv) || 7 * 24 * 60 * 60\n  const exp = iat + expSeconds\n  const body = { ...payload, iat, exp }\n  const encodedHeader = base64url(JSON.stringify(header))\n  const encodedBody = base64url(JSON.stringify(body))\n  const signingInput = `${encodedHeader}.${encodedBody}`\n  let signature: Buffer\n  if (hasRS256) {\n    const privateKeyPem = (process.env.JWT_PRIVATE_KEY || \"\").trim()\n    const signer = crypto.createSign(\"RSA-SHA256\")\n    signer.update(signingInput)\n    signer.end()\n    signature = signer.sign(privateKeyPem)\n  } else {\n    const secret = (process.env.JWT_SECRET || \"\").trim()\n    const hmac = crypto.createHmac(\"sha256\", secret)\n    hmac.update(signingInput)\n    signature = hmac.digest()\n  }\n  const encodedSignature = base64url(signature)\n  return `${signingInput}.${encodedSignature}`\n}\n\nexport async function verifyJwt(token: string) {\n  const parts = token.split(\".\")\n  if (parts.length !== 3) throw new Error(\"invalid_token\")\n  const [encodedHeader, encodedBody, encodedSignature] = parts\n  const signingInput = `${encodedHeader}.${encodedBody}`\n  const signature = Buffer.from(encodedSignature.replace(/-/g, \"+\").replace(/_/g, \"/\"), \"base64\")\n  const hasRS256 = !!(process.env.JWT_PRIVATE_KEY && process.env.JWT_PUBLIC_KEY)\n  let ok: boolean\n  if (hasRS256) {\n    const publicKeyPem = (process.env.JWT_PUBLIC_KEY || \"\").trim()\n    const verifier = crypto.createVerify(\"RSA-SHA256\")\n    verifier.update(signingInput)\n    verifier.end()\n    ok = verifier.verify(publicKeyPem, signature)\n  } else {\n    const secret = (process.env.JWT_SECRET || \"\").trim()\n    const hmac = crypto.createHmac(\"sha256\", secret)\n    hmac.update(signingInput)\n    const expected = hmac.digest()\n    ok = crypto.timingSafeEqual(expected, signature)\n  }\n  if (!ok) throw new Error(\"invalid_signature\")\n  const payloadJson = Buffer.from(encodedBody.replace(/-/g, \"+\").replace(/_/g, \"/\"), \"base64\").toString(\"utf8\")\n  const payload = JSON.parse(payloadJson)\n  const now = Math.floor(Date.now() / 1000)\n  if (payload.exp && now > payload.exp) throw new Error(\"token_expired\")\n  return payload\n}\n"],"names":[],"mappings":"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"}