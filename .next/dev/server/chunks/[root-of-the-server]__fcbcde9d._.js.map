{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User/Desktop/outros/market-delivery-app/app/api/orders/%5Bid%5D/status/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\r\nimport { PrismaClient } from \"@prisma/client\"\r\nimport { Pool } from \"pg\"\r\nimport { PrismaPg } from \"@prisma/adapter-pg\"\r\nimport { OrderStatus } from \"@prisma/client\"\r\n\r\n// Initialize Prisma Client directly in the route\r\nconst createPrismaClient = () => {\r\n  const connectionString = process.env.DATABASE_URL\r\n  \r\n  if (!connectionString) {\r\n    throw new Error(\"DATABASE_URL environment variable is not set\")\r\n  }\r\n  \r\n  const pool = new Pool({ connectionString })\r\n  const adapter = new PrismaPg(pool)\r\n  \r\n  return new PrismaClient({\r\n    adapter,\r\n  })\r\n}\r\n\r\n// Simple JWT verification function (you might want to move this to a shared utility)\r\nasync function verifyJwt(token: string) {\r\n  try {\r\n    // This is a simplified version - in production, you'd want to properly verify the JWT\r\n    const payload = JSON.parse(atob(token.split('.')[1]))\r\n    return payload\r\n  } catch {\r\n    throw new Error(\"Invalid token\")\r\n  }\r\n}\r\n\r\nexport async function PUT(req: NextRequest, { params }: { params: { id: string } }) {\r\n  try {\r\n    // Get token from Authorization header or cookies\r\n    let token: string | null = null\r\n    const authHeader = req.headers.get(\"authorization\")\r\n    \r\n    if (authHeader && authHeader.startsWith(\"Bearer \")) {\r\n      token = authHeader.substring(7)\r\n    } else {\r\n      // If not in header, try to get from cookies\r\n      const cookieHeader = req.headers.get(\"cookie\")\r\n      if (cookieHeader) {\r\n        // Split cookies by semicolon and trim whitespace\r\n        const cookies = cookieHeader.split(\";\").reduce((acc, cookie) => {\r\n          const [name, value] = cookie.trim().split(\"=\")\r\n          if (name && value) {\r\n            acc[name] = value\r\n          }\r\n          return acc\r\n        }, {} as Record<string, string>)\r\n        \r\n        token = cookies.token || null\r\n      }\r\n    }\r\n    \r\n    if (!token) {\r\n      return NextResponse.json({ error: \"unauthorized\" }, { status: 401 })\r\n    }\r\n    \r\n    // Verify the JWT token\r\n    let decoded\r\n    try {\r\n      decoded = await verifyJwt(token)\r\n    } catch {\r\n      return NextResponse.json({ error: \"invalid_token\" }, { status: 401 })\r\n    }\r\n    \r\n    // Create Prisma client\r\n    const prisma = createPrismaClient()\r\n    \r\n    // Check if user is admin\r\n    const user = await prisma.user.findUnique({\r\n      where: { id: decoded.sub },\r\n    })\r\n    \r\n    if (!user || user.role !== \"ADMIN\") {\r\n      return NextResponse.json({ error: \"forbidden\" }, { status: 403 })\r\n    }\r\n    \r\n    // Get the order ID from params\r\n    const orderId = params.id\r\n    \r\n    // Get the new status from request body\r\n    const body = await req.json()\r\n    const { status } = body\r\n    \r\n    // Validate status\r\n    if (!status || !Object.values(OrderStatus).includes(status as OrderStatus)) {\r\n      return NextResponse.json({ error: \"invalid_status\" }, { status: 400 })\r\n    }\r\n    \r\n    // Update the order status\r\n    const updatedOrder = await prisma.order.update({\r\n      where: { id: orderId },\r\n      data: { status: status as OrderStatus },\r\n      include: {\r\n        user: {\r\n          select: {\r\n            id: true,\r\n            name: true,\r\n            phone: true,\r\n            email: true,\r\n            cpf: true,\r\n          }\r\n        },\r\n        items: true,\r\n        deliveryAddress: true,\r\n      }\r\n    })\r\n    \r\n    return NextResponse.json(updatedOrder)\r\n  } catch (error: any) {\r\n    console.error(\"Error updating order status:\", error)\r\n    \r\n    if (error.code === \"P2025\") {\r\n      return NextResponse.json({ error: \"order_not_found\" }, { status: 404 })\r\n    }\r\n    \r\n    return NextResponse.json({ error: \"internal_server_error\" }, { status: 500 })\r\n  }\r\n}"],"names":[],"mappings":"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"}}]
}